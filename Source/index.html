<script>
function n2f(n) {
  return Math.pow(2, (n - 69) / 12) * 440;
}

function assert(predicat, msg) {
  if (!predicat) {
    throw msg;
  }
}

ac = new AudioContext();

var params = {
  "kick": {
    "volume": {
      "min": 0.0,
      "max": 3.0,
      "step": 0.01,
      "default": 1 
    },
    "release": {
      "min": 0.0,
      "max": 10.0,
      "step": 0.001,
      "default": 1.5
    },
    "pitch": {
      "min": 30.,
      "max": 300.,
      "step": 1,
      "default": 45.
    },
    "noise release": {
      "min": 0.0001,
      "max": 0.03,
      "step": 0.001,
      "default": 0.002
    },
    "noise gain": {
      "min": 0.0,
      "max": 10.0,
      "step": 0.01,
      "default": 1.45
    },
    "lowpass": {
      "min": 20.0,
      "max": 20000.0,
      "step": 1,
      "default": 6000. 
    },
  },
  "snare": {
    "volume": {
      "min": 0.0,
      "max": 3.0,
      "step": 0.01,
      "default": 1 
    },
    "noise release": {
      "min": 0.0,
      "max": 2.0,
      "step": 0.01,
      "default": 0.06
    },
    "body release": {
      "min": 0.0,
      "max": 2.0,
      "step": 0.01,
      "default": 0.04
    },
    "lowpass": {
      "min": 50.0,
      "max": 10000.0,
      "step": 1,
      "default": 3800.
    },
    "pitch": {
      "min": 200.,
      "max": 1000.,
      "step": 1.,
      "default": 284.
    }
  },
  "hihat": {
    "volume": {
      "min": 0.0,
      "max": 3.0,
      "step": 0.01,
      "default": 2.6
    },
    "release hipass": {
      "min": 0.0,
      "max": 0.3,
      "step": 0.01,
      "default": 0.09
    },
    "release bandpass": {
      "min": 0.0,
      "max": 0.3,
      "step": 0.01,
      "default": 0.04
    },
    "bandpass freq": {
      "min": 0.0,
      "max": 15000.,
      "step": 0.1,
      "default": 11800. 
    },
    "highpass freq": {
      "min": 0.0,
      "max": 15000.,
      "step": 0.1,
      "default": 7300. 
    },
    "osc1 freq": {
      "min": 0.0,
      "max": 20000.,
      "step": 1,
      "default": 50. 
    },
    "osc2 freq": {
      "min": 0.0,
      "max": 20000.,
      "step": 1,
      "default": 100. 
    },
    "osc3 freq": {
      "min": 0.0,
      "max": 20000.,
      "step": 1,
      "default": 150. 
    },
    "osc4 freq": {
      "min": 0.0,
      "max": 20000.,
      "step": 1,
      "default": 200
    },
    "osc5 freq": {
      "min": 0.0,
      "max": 20000.,
      "step": 1,
      "default": 250. 
    },
    "osc6 freq": {
      "min": 0.0,
      "max": 20000.,
      "step": 1,
      "default": 300. 
    },
  },
  "subs": {
    "volume": {
      "min": 0.0,
      "max": 3.0,
      "step": 0.01,
      "default": 1 
    },
    "cutoff": {
      "min": 0.0,
      "max": 15000.,
      "step": 0.1,
      "default": 10000. 
    },
    "Q": {
      "min": 0.0,
      "max": 80.,
      "step": 0.1,
      "default": 15. 
    },
    "detune": {
      "min": -1200.0,
      "max": +1200.0,
      "step": 1.,
      "default": -1200. 
    },
    "filter attack": {
      "min": 0.01,
      "max": 0.5,
      "step": 0.01,
      "default": 0.01
    },
    "attack": {
      "min": 0.0,
      "max": 1.,
      "step": 0.01,
      "default": 0.01
    },
    "release": {
      "min": 0.001,
      "max": 1.,
      "step": 0.01,
      "default": 0.05
    }
  },
  "clave": {
    "volume": {
      "min": 0.0,
      "max": 3.0,
      "step": 0.01,
      "default": 1 
    },
    "freq": {
      "min": 0.0,
      "max": 15000.,
      "step": 0.1,
      "default": 5230.3
    },
    "pitch": {
      "min": 20,
      "max": 3000,
      "step": 0.1,
      "default": 2590.3,
    },
    "release": {
      "min": 0.001,
      "max": 1.,
      "step": 0.01,
      "default": 0.02
    }
  },
  "sends": {
    "delay": {
      "feedback": {
        "min": 0.0,
        "max": 1.50,
        "step": 0.01,
        "default":0.30
      },
      "time": {
        "min": 0.0,
        "max": 3.0,
        "step": 0.01,
        "default":0.33
      }
    },
    "reverb": {
      "length": {
        "min": 0.0,
        "max": 50.,
        "step": 0.1,
        "default":1.
      },
      "decay": {
        "min": 0.0,
        "max": 20.,
        "step": 0.1,
        "default":5.
      }
    },
  },
  "master": {
    "compression": {
      "threshold": {
        "min": -48.,
        "max": 0.,
        "step": 0.1,
        "default": -12.
      },
      "knee": {
        "min": 0.0,
        "max": 40.,
        "step": 0.1,
        "default":30.
      },
      "ratio": {
        "min": 0.0,
        "max": 40.,
        "step": 0.1,
        "default":4.
      },
      "attack": {
        "min": 0.0,
        "max": 1.,
        "step": 0.001,
        "default":0.003
      },
      "release": {
        "min": 0.0,
        "max": 1.,
        "step": 0.01,
        "default":0.25
      }
    }
  }
};
// map params to integers
// var ws = new WebSocket("ws://localhost:7681", "tmpsnd");
var ws = new WebSocket("ws://127.0.0.1:7681", "tmpsnd");
// var ws = new WebSocket("ws://10.243.29.98:7681", "tmpsnd");
ws.onopen = function(e) {
  console.log(JSON.stringify(params));
  ws.send(JSON.stringify(params));
}

function trigger(tuple) {
  var t = ac.currentTime;
  // t+= 0.1; // give some slack for scheduling in case the main thread is busy pixeling
  channels[tuple[1]].play(t /* delta t */,
                          n2f(tuple[2]) /* note */,
                          (tuple[3] - 1) / 127);
}

function stop(tuple) {
  var t = ac.currentTime;
  // t+= 0.1; // give some slack for scheduling in case the main thread is busy pixeling
  if (channels[tuple[1]].stop) {
    channels[tuple[1]].stop(t);
  }
}

parameters = [];

function registerParameters(param) {
  if (param instanceof AudioParam) {
    parameters.push({value: 0.0, audioparam: param});
  } else if (param instanceof Function) {
    parameters.push({value: 0.0, func: param});
  } else {
    parameters.push(param);
  }
  return parameters.length - 1;
}

function setParameter(tuple) {
  tuple[0] = ac.currentTime;
  if (tuple[1] > parameters.length - 1) {
    console.log("param out of range");
    return;
  }
  if (parameters[tuple[1]].audioparam) { // AudioParam
    parameters[tuple[1]].audioparam.setValueAtTime(tuple[2], tuple[0]);
    parameters[tuple[1]].value = tuple[2];
  } else if (parameters[tuple[1]].func) { // Function
    parameters[tuple[1]].func(tuple[2], tuple[0]);
    parameters[tuple[1]].value = tuple[2];
  } else {                                // Simple value
    parameters[tuple[1]].value = tuple[2];
  }
}

function getParameter(index) {
  return parameters[index].value;
}

function noiseBuffer() {
  var buf = ac.createBuffer(1, ac.sampleRate * 0.5, ac.sampleRate / 2);
  var c = buf.getChannelData(0);
  for(var i = 0; i < c.length; i++) { 
    c[i] = Math.random() * 2.0 - 1.0; 
  }
  return buf;
}

function release(t, param, startValue, endValue, constant) {
  // param.cancelScheduledValues(t);
  param.setValueAtTime(startValue, t);
  param.setTargetAtTime(endValue, t+0.005, constant);
}

instruments = [
  function kick(sink) {
    var bodyrelease = {value : 0.0};
    var noiserelease = {value : 0.0};
    var noisemix = {value : 0.0};
    var kickfreq = {value : 0.0};
    var lopass = {value: 0.0};

    var osc = ac.createOscillator();
    var velocity = ac.createGain();
    var bodyenveloppe = ac.createGain();
    var noiseenveloppe = ac.createGain();
    var lopass = ac.createBiquadFilter();

    bodyenveloppe.gain.setValueAtTime(0, 0);
    noiseenveloppe.gain.setValueAtTime(0, 0);
    osc.frequency.setValueAtTime(0, 0);

    osc.connect(bodyenveloppe);
    noiseenveloppe.connect(lopass);
    bodyenveloppe.connect(velocity);
    lopass.connect(velocity);
    velocity.connect(sink);

    var KICK_RELEASE = registerParameters(bodyrelease);
    var KICK_FREQUENCY = registerParameters(kickfreq);
    var NOISE_RELEASE = registerParameters(noiserelease);
    var NOISE_MIX = registerParameters(noisemix);
    registerParameters(lopass.frequency);

    this.play = function(t, freq, vel) {
      var s = ac.createBufferSource();
      s.buffer = noiseBuffer();
      s.connect(noiseenveloppe);
      s.start();

      velocity.gain.setValueAtTime(vel, t);
      release(t, bodyenveloppe.gain, 1, 0, getParameter(KICK_RELEASE) / 3);
      release(t, noiseenveloppe.gain, getParameter(NOISE_MIX) * vel, 0, getParameter(NOISE_RELEASE));
      release(t, osc.frequency, getParameter(KICK_FREQUENCY) * 2, getParameter(KICK_FREQUENCY), 0.03);
    }

    osc.start();
  },
 function snare(sink) {
  var noiserelease = {value: 0.0};
  var bodyrelease = {value: 0.0};
  var tonerelease = {value: 0.0};
  var snarepitch = {value: 0.0};
  var lowpass = {value: 0.0};

  var lopass = ac.createBiquadFilter();
  var osc1 = ac.createOscillator();
  osc1.type = "triangle";
  var osc2 = ac.createOscillator();
  osc2.type = "triangle";
  var osc3 = ac.createOscillator();
  var osc4 = ac.createOscillator();
  var velocity = ac.createGain();

  var enveloppe = ac.createGain();
  var enveloppeBody = ac.createGain();

  var NOISE_RELEASE = registerParameters(noiserelease);
  var BODY_RELEASE = registerParameters(bodyrelease);
  var LOWPASS_CUTOFF = registerParameters(lowpass);
  var SNARE_PITCH = registerParameters(snarepitch);

  enveloppe.gain.setValueAtTime(0, 0);
  enveloppeBody.gain.setValueAtTime(0, 0);

  osc1.connect(enveloppeBody);
  osc2.connect(enveloppeBody);
  osc3.connect(enveloppeBody);
  osc4.connect(enveloppeBody);

  osc1.frequency.value = 111 + 175;
  osc2.frequency.value = 111 + 224;
  osc3.frequency.value = 380;
  osc4.frequency.value = 180;

  enveloppeBody.connect(lopass);
  enveloppe.connect(lopass);
  lopass.connect(velocity);
  velocity.connect(sink);
  noisebuffer = noiseBuffer();

  this.play = function(t, freq, vel) {
    var noise = ac.createBufferSource();
    noise.buffer = noisebuffer;
    noise.connect(enveloppe);
    noise.start(0);
    lopass.frequency.setValueAtTime(getParameter(LOWPASS_CUTOFF), t);

    velocity.gain.setValueAtTime(vel, t);

    release(t, enveloppe.gain, vel, 0, getParameter(NOISE_RELEASE));
    release(t, enveloppeBody.gain, vel, 0, getParameter(BODY_RELEASE));
  }

  osc1.start();
  osc2.start();
  osc3.start();
  osc4.start();
 },
 function hihat(sink) {
  var relhigh = {value: 0.0};
  var relband = {value: 0.0};
  var cutoff = {value: 0.0};
  var hipass= {value: 0.0};

  var enveloppehigh = ac.createGain();
  var enveloppeband = ac.createGain();
  var bandpass = ac.createBiquadFilter();
  var highpass = ac.createBiquadFilter();
  var velocity = ac.createGain();

  var osc1 = ac.createOscillator();
  var osc2 = ac.createOscillator();
  var osc3 = ac.createOscillator();
  var osc4 = ac.createOscillator();
  var osc5 = ac.createOscillator();
  var osc6 = ac.createOscillator();
  osc1.type = osc2.type = osc3.type = osc4.type = osc5.type = osc6.type = "square";

  enveloppehigh.gain.setValueAtTime(0, 0);
  enveloppeband.gain.setValueAtTime(0, 0);
  bandpass.type = "bandpass";
  highpass.type = "highpass";

  var RELHIGH= registerParameters(relhigh);
  var RELBAND= registerParameters(relband);
  var BANDPASS = registerParameters(bandpass);
  var HIGHPASS = registerParameters(hipass);
  registerParameters(osc1.frequency);
  registerParameters(osc2.frequency);
  registerParameters(osc3.frequency);
  registerParameters(osc4.frequency);
  registerParameters(osc5.frequency);
  registerParameters(osc6.frequency);

  osc1.connect(bandpass);
  osc2.connect(bandpass);
  osc3.connect(bandpass);
  osc4.connect(bandpass);
  osc5.connect(bandpass);
  osc6.connect(bandpass);
  osc1.connect(highpass);
  osc2.connect(highpass);
  osc3.connect(highpass);
  osc4.connect(highpass);
  osc5.connect(highpass);
  osc6.connect(highpass);
  highpass.connect(enveloppehigh);
  bandpass.connect(enveloppeband);
  enveloppehigh.connect(velocity)
  enveloppeband.connect(velocity)
  velocity.connect(sink)


  this.play = function(t, freq, vel) {
    // humanization
    bandpass.frequency.value = getParameter(BANDPASS) + (Math.random() - 0.5) * 1000;
    highpass.frequency.value = getParameter(HIGHPASS) + (Math.random() - 0.5) * 1000;
    velocity.gain.setValueAtTime(vel, t);
    // we divide by four to get some sort of reasonnable gain range
    release(t, enveloppehigh.gain, vel / 4, 0, getParameter(RELHIGH));
    release(t, enveloppeband.gain, vel / 4, 0, getParameter(RELBAND));
  }
  osc1.start();
  osc2.start();
  osc3.start();
  osc4.start();
  osc5.start();
  osc6.start();
 },
 function substractive(sink) {
  var q = {value: 0.0};
  var detune = {value: 0.0};
  var filterattack = {value: 0.0};
  var attack = {value:0.0};
  var rel= {value:0.0};

  var osc1 = ac.createOscillator();
  osc1.type = "sawtooth";
  var osc2 = ac.createOscillator();
  osc2.type = "sawtooth";
  var filter = ac.createBiquadFilter();
  var enveloppe = ac.createGain();

  var CUTOFF = registerParameters(filter.frequency);
  var Q = registerParameters(q);
  var DETUNE = registerParameters(detune);
  var FILTER_ATTACK = registerParameters(filterattack);
  var ATTACK = registerParameters(attack);
  var RELEASE = registerParameters(rel);

  osc1.connect(filter);
  osc2.connect(filter);
  filter.connect(enveloppe);
  enveloppe.connect(sink);

  enveloppe.gain.setValueAtTime(0, 0);

  this.play = function(t, freq, vel) {
    osc1.frequency.setValueAtTime(freq, t);
    osc2.frequency.setValueAtTime(freq, t);
    osc2.detune.setValueAtTime(getParameter(DETUNE), t);

    filter.Q.value = getParameter(Q);

    enveloppe.gain.setValueAtTime(0, t);
    enveloppe.gain.linearRampToValueAtTime(vel, t + getParameter(ATTACK));

    filter.frequency.setValueAtTime(0, t);
    filter.frequency.linearRampToValueAtTime(getParameter(CUTOFF), t + getParameter(FILTER_ATTACK));
  }

  this.stop = function(t) {
    enveloppe.gain.setTargetAtTime(0, t, getParameter(RELEASE));
  }

  osc1.start();
  osc2.start();
 },
 function clave(sink) {
   var rel = { value: 0.0 };
   var osc = ac.createOscillator();
   osc.type = "triangle";

   var velocity = ac.createGain();
   var enveloppe = ac.createGain();

   var filter = ac.createBiquadFilter();
   filter.type = "bandpass";

   registerParameters(filter.frequency);
   registerParameters(osc.frequency);
   var CLAVE_RELEASE = registerParameters(rel);

   osc.frequency.setValueAtTime(0, 0);
   filter.frequency.setValueAtTime(0, 0);
   velocity.gain.setValueAtTime(0, 0);
   enveloppe.gain.setValueAtTime(0, 0);

   osc.connect(enveloppe);
   enveloppe.connect(velocity);
   velocity.connect(filter);
   filter.connect(sink);

   this.play = function(t, freq, vel) {
     velocity.gain.setValueAtTime(vel, t);
     release(t, enveloppe.gain, 1, 0, getParameter(CLAVE_RELEASE));
   }
   osc.start();
 }
]

channels = [];

function reverbBuffer(length, decay) {
  var i,l;
    var len = ac.sampleRate * length;
    var buffer = ac.createBuffer(2, len, ac.sampleRate)
    var iL = buffer.getChannelData(0)
    var iR = buffer.getChannelData(1)
    for(i=0,l=buffer.length;i<l;i++) {
      iL[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
      iR[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
    }
  return buffer;
}

var master = ac.createGain();
var analyser = ac.createAnalyser();
master.connect(analyser);
var comp = ac.createDynamicsCompressor();
master.connect(comp);
comp.connect(ac.destination);

var reverb = ac.createConvolver();
reverb.buffer = reverbBuffer(2, 5);
reverb.connect(master);

var delay = ac.createDelay();
delay.delayTime.value = 0.3;
var delayGain = ac.createGain();
delay.connect(delayGain);
delayGain.connect(delay);
delayGain.connect(master);

tmpsnd = function() {
  channels.push([]); // 1 indexed
  for (var i in instruments) {
    var volume = ac.createGain();
    registerParameters(volume.gain);
    var send_delay = ac.createGain();
    var send_reverb = ac.createGain();
    channels.push(new instruments[i](volume));
    volume.connect(master);
    volume.connect(send_delay);
    volume.connect(send_reverb);
    send_delay.gain.value = 0.0;
    send_reverb.gain.value = 0.0;
    send_delay.connect(delay);
    send_reverb.connect(reverb);
    registerParameters(send_delay.gain);
    registerParameters(send_reverb.gain);
  }
  registerParameters(delayGain.gain);
  registerParameters(delay.delayTime);

  var REVERB_LENGTH = registerParameters(function(newValue) {
    reverb.buffer = reverbBuffer(newValue, getParameter(REVERB_DECAY));
  });
  var REVERB_DECAY = registerParameters(function(newValue) {
    reverb.buffer = reverbBuffer(getParameter(REVERB_LENGTH), newValue);
  });
  registerParameters(comp.ratio);
  registerParameters(comp.threshold);
  registerParameters(comp.knee);
  registerParameters(comp.ratio);
  registerParameters(comp.attack);
  registerParameters(comp.release);
}


function onmsg(e) {
  // in any case, tuple[0] is the time, tuple[1] is the index of the thing to
  // touch
  // for a param change, tuple[2] is the new value
  // for a note trigger, tuple[2] is the note, tuple[3] is the velocity
  var tuple = e.data.split(",").map(Number);
  console.log(e.data);

  // snare
  if (tuple[1] == 1 && tuple[2] == 38) {
    tuple[1] = 2;
  }
  //clave
  if (tuple[1] == 1 && tuple[2] == 39) {
    tuple[1] = 4;
  }
  // hihat
  if (tuple[1] == 1 && tuple[2] == 40) {
    tuple[1] = 3;
  }
  switch (tuple.length) {
    case 3: // parameter change
      setParameter(tuple);
      break;
    case 4: // note trigger
      trigger(tuple);
      break;
    case 2: //note off
      stop(tuple);
      break;
    default:
      throw "weird message";
  }
}

ws.onmessage = onmsg;

tmpsnd();

document.onvisibilitychanged = function() {
  if(document.hidden) {
    console.log("hidden")
    ws.onmessage = function() {};
  } else {
    console.log("not")
    ws.onmessage = onmsg;
  }
}

window.onload = function() {
  var cvs = document.querySelector("canvas");
  var w = cvs.width = window.innerWidth;
  var h = cvs.height = window.innerHeight;

  analyser.fftSize = 2048;

  var fftarray = new Float32Array(analyser.frequencyBinCount);
  var timearray = new Float32Array(analyser.frequencyBinCount);

  var binwidth = Math.ceil(w / analyser.frequencyBinCount) / 2;

  var c = cvs.getContext("2d");

  function render() {
    c.clearRect(0, 0, w, h);
    analyser.getFloatFrequencyData(fftarray);
    analyser.getFloatTimeDomainData(timearray);
    var offset = 0;
    c.beginPath();
    c.lineWidth = 3;
    c.strokeStyle = "rgb(100, 100, 100)";
    c.moveTo(0, h/2);
    for (var i = 0; i < fftarray.length; i++) {
      var normalized = (fftarray[i] - analyser.minDecibels) / -(analyser.minDecibels + analyser.maxDecibels);
      c.fillRect(offset, h - normalized * h, binwidth, normalized * h);
      c.lineTo(offset, h/2 + timearray[i] * 100);
      offset += binwidth * 1.5;
    }
    var reduction = comp.reduction instanceof AudioParam ? comp.reduction.value : comp.reduction;
    c.fillRect(w - 100, h, w, reduction * 40);
    c.stroke();
    requestAnimationFrame(render);
  }
  requestAnimationFrame(render);
}


</script>
<canvas></canvas>
